= Configuring API Gateway API Autodiscovery in a Mule 4 Application

The intended audience for this paper are those who are interested in learning how to configure the API Autodiscovery in a Mule 4 application. 
It is important to note that this is different from a Mule 3 application. 

== Changes from Mule 3.x Configuration

API Autodiscovery element has syntactically changed from Mule 3.x but its purpose remains the same. The element in a Mule Application has the following format:

[%header%autowidth.spread,cols="a,a"]
|===
^| Mule 3.x XML element ^| Mule 4.x XML element
^| <api-platform-gw:api (...)/>. ^| <api-gateway:autodiscovery (...)/>.
|===

In Mule 4, the API is identified by the API ID and a reference to a Flow where the HTTP listener is defined. Mule 4â€™s apiId replaces the apiName and apiVersion used to specify the Autodiscovery element in Mule 3.x and prior.



== Making your API Available in API Manager

The API to which you want to pair your Mule application must be available in API Manager. +
You can either:

* Publish your API in Exchange and import it from there to the API Manager. +
See xref:manage-exchange-api-task.adoc[To Manage an API from Exchange].
* Import it directly from your machine. +
See xref:import-api-task.adoc[To Import an API Instance] for more details.

API Manager generates an "API ID" identifier for every imported API:

image::api-id.png[align=center]

This API ID is required by the Autodiscovery element to identify the API that you would like to pair to your application.

== Using the Mule Application as an API Proxy

These steps are necessary to instruct the API Manager to use your deployed Mule application as the API proxy itself.

. For Managing type, select Basic Endpoint.
. Add the Implementation URL that points to the deployed Mule application. //Give an example of how to do this step, or provide a link that further explains this
. Select the checkmark `Check this box if you are managing this API in Mule 4 or above`.

== Configuring Anypoint Platform Organization Credentials in Mule Runtime

To use Autodiscovery in a Mule Application, the Runtime must start with the Anypoint Platform credentials already configured. +
Learn how to configure your organization credentials based on your deployment target in xref:org-credentials-config-mule4.adoc[Configuring Organization Credentials in Mule Runtime 4].

== Configuring the Autodiscovery Element in Your Mule Application

Within the code of your Mule Application, you must configure the `api-gateway:Autodiscovery` element. +
The Autodiscovery element points to the specific API in API Manager to which you want to pair.
You can accomplish these steps in two ways: 

* Make changes to the .XML element itself //Give further explanation to what this line of code does, or how to use it
  Note: This code applies to Mule 4.x version. If you are using 3.x, please refer to the next section. 
[source,xml,linenums]
----
<api-gateway:autodiscovery
  apiId="${apiId" // <1>
  flowRef= myFlow /> // <2>
----

<1> Configure the `apiId` with the API ID that API Manager assigned to your API. //Give example steps to successfully complete this step
<2> Set the `flowRef` element to point to the flow that you want to pair to the API in API Manager. //Give example steps to successfully complete this step

You can either: 
  * Replace `${apiId}` with your specific value
  * Create a `config.properties` file where you define it in a key-value fashion: `apiId=[your-specific-value]` and reference it as `${apiId}` in this configuration.

* Configure this using Anypoint Studio's UI:

. In your existing flow, select the Global Elements tab in your Mule Configuration File editor.
. Click the Create button, and look for the API Autodiscovery global element.
+
image::auto-discovery-studio-7.png[align=center]
. Set the API ID and Flow Reference. +
+
image::auto-discovery-api-config.png[align=center]
+
You can also choose to use the `${apiId}` value and reference it from a `config.properties` file.

After the element is defined in the application and the runtime is configured with your Anypoint Platform credentials, Mule Runtime will automatically track and keep up to date with the API configuration that is defined in API Manager.
//_COMBAK: Does this need to be deployed for the green dot to show in API Manager?

[TIP]
If you configured a proxy endpoint for your API, your autogenerated proxy will already be correctly configured with the Autodiscovery element.


== See Also

* xref:api-auto-discovery-new-concept.adoc[Reviewing API Gateway API Autodiscovery concepts
